var advOrigVideoSettings={};var advVideoSettings={};function openVideoAdvanced(){var h={};var g=5/12;function i(n){$("#confmodal"+n).modal("hide").remove();videoManager.showAll()}function a(o){var n=videoManager.getProperty("ROIs","videoAdv"+o).split(",");$.each(n,function(q,r){var p=map(r.split(":"),function(t,s){return(parseDecimal(s))});advVideoSettings["str"+o+"x"+(q+1)]=p[0];advVideoSettings["str"+o+"y"+(q+1)]=p[1];advVideoSettings["str"+o+"w"+(q+1)]=p[2];advVideoSettings["str"+o+"h"+(q+1)]=p[3];$("#regStr"+o+"r"+(q+1)+"x").val(p[0]);$("#regStr"+o+"r"+(q+1)+"y").val(p[1]);$("#regStr"+o+"r"+(q+1)+"w").val(p[2]);$("#regStr"+o+"r"+(q+1)+"h").val(p[3])});$("#confmodal"+o).modal("hide").remove();$("#regions"+o).html(k(o));videoManager.showAll()}function m(n,o){videoManager.setProperty("deleteROIs",o,"videoAdv"+n);$("#str"+n+"rgn"+o+"x").val(0);$("#str"+n+"rgn"+o+"y").val(0);$("#str"+n+"rgn"+o+"w").val(0);$("#str"+n+"rgn"+o+"h").val(0);e(n)}function e(o){var n=videoManager.getProperty("ROIs","videoAdv"+o).split(",");logDebug("ROIs are ",n);$.each(n,function(q,r){var p=q+1;r=r.split(":");r[0]=parseDecimal(r[0]);r[1]=parseDecimal(r[1]);r[2]=parseDecimal(r[2]);r[3]=parseDecimal(r[3]);$("#str"+o+"rgn"+p+"x").val(r[0]);$("#str"+o+"rgn"+p+"y").val(r[1]);$("#str"+o+"rgn"+p+"w").val(r[2]);$("#str"+o+"rgn"+p+"h").val(r[3])})}function b(o,p,v){var s=[];var t=["X","Y","Width","Height"];var u=["x","y","w","h"];var n=t.length;var q;s[0]=mkInlineSelectionInput("","select"+o,["Region1","Region2","Region3"],{selectClass:"input-small"});for(var r=1;r<=n;r++){q=$("#regStr"+p+"r"+v+u[r-1]).val();if(q>0&&q<3){q=0}else{if(q>2&&q<6){q=4}else{if(q>6&&q<12){q=9}}}s[r]=mkInlineInput({id:"str"+p+o+u[r-1],"class":"input-micro",label:t[r-1]+"  ",maxlength:3,disabled:true,value:q})}s[n+1]=mkButton("Delete","").click(function(){m(p,v)});return s}function c(o,p,v,u){var r=[];var s=["X","Y","Width","Height"];var t=["x","y","w","h"];var n=s.length;r[0]=mkElem("label",{},u+" ");for(var q=1;q<=n;q++){r[q]=mkInlineInput({id:"regStr"+p+o+t[q-1],"class":"input-micro",label:s[q-1]+"  ",maxlength:4,value:advVideoSettings["str"+p+t[q-1]+v],change:curry(updateFromInput,advVideoSettings,"str"+p+t[q-1]+v,"regStr"+p+o+t[q-1])})}return r}function k(n){return[mkElem("div",{id:"region1","class":"form-inline"},c("r1",n,1,"Region1")),mkElem("div",{id:"region2","class":"form-inline"},c("r2",n,2,"Region2")),mkElem("div",{id:"region3","class":"form-inline"},c("r3",n,3,"Region3"))]}function d(n){videoManager.hideAll();$("#ROIModal"+n).html(f(n));$("#regionsInModal"+n).html(j(n));$("#confmodal"+n).modal("show");$("#videoAdv"+n).removeAttr("style");videoManager.play(origVideoSettings.getStreamUrl(0),"videoAdv"+n)}function j(n){return mkElem("div",{"class":"form-inline"},[mkElem("div",{id:"roi1","class":"form-inline"},b("rgn1",n,1)),mkElem("div",{id:"roi2","class":"form-inline"},b("rgn2",n,2)),mkElem("div",{id:"roi3","class":"form-inline"},b("rgn3",n,3))])}function f(o){var n=mkElemClass("div",{id:"rgnConfId"},[centerWrap(mkElem("div",{id:"videoAdvancedInModal"+o})),mkElem("div",{id:"regionsInModal"+o})]);var q=mkElem("div",{id:"cngFooterId"},[mkButton("Refresh preview"," ").click(function(){e(o)}),mkButton("OK"," ").click(curry(a,o)),mkButton("Cancel"," ").click(curry(i,o))]);var p=mkModal("confmodal"+o,"message ",mkElem("h3",{},"Region of Interest"),n,q,true,curry(i,o));p.modal({backdrop:"static"});return p}function l(o){var q=o+1;var n=advVideoSettings["streamname"+q].split(/@/g)[0];function p(r){return[mkControlGroup("IP Ratio",mkInputElem({id:"IpRatio"+r,"class":"input-medium",value:advVideoSettings["ipratio"+r],maxlength:4,change:curry(updateFromInput,advVideoSettings,"ipratio"+r,"IpRatio"+r)}),""),mkControlGroup("Force I Frame",mkInlineCheckButtonElem(" ","iframe"+r,{checked:advVideoSettings["forceiframe"+r]===1?true:false,change:function(s){advVideoSettings["forceiframe"+r]=s?1:0}}),""),mkControlGroup("QP Value",mkElem("div",{id:"qpVal"+r,"class":"form-inline"},[mkInlineInput({id:"init"+r,"class":"input-micro",label:"Init  ",value:advVideoSettings["qpinit"+r],maxlength:3,change:curry(updateFromInput,advVideoSettings,"qpinit"+r,"init"+r)}),mkInlineInput({id:"min"+r,"class":"input-micro",label:"Min  ",value:advVideoSettings["qpmin"+r],maxlength:3,change:curry(updateFromInput,advVideoSettings,"qpmin"+r,"min"+r)}),mkInlineInput({id:"max"+r,"class":"input-micro",label:"Max  ",value:advVideoSettings["qpmax"+r],maxlength:3,change:curry(updateFromInput,advVideoSettings,"qpmax"+r,"max"+r)})]),""),mkControlGroup("Encode Preset",mkInlineSelectionInput(" ","selectEncoding"+r,advVideoSettings.meConfigs,{selectClass:"input-medium",selectedIndex:advVideoSettings["meconfig"+r],change:curry(updateFromCombo,advVideoSettings,"meconfig"+r,"selectEncoding"+r)}),""),mkControlGroup("Packet Size ",mkElem("div",{id:"packetSize"+r,"class":"form-inline"},[mkInlineInput({id:"packet"+r,"class":"input-small",label:"",value:advVideoSettings["packetsize"+r],maxlength:3,change:curry(updateFromInput,advVideoSettings,"packetsize"+r,"packet"+r)}),mkElem("label",{},"% Frame Data Value")]),""),mkElem("div",{id:"regoi"+r,"class":"form-inline"},[mkInlineCheckButtonElem("Enable Region of Interest","enableROI"+r,{checked:advVideoSettings["regionofinterestenable"+r]===1?true:false,change:function(t){var s=t?1:0;advVideoSettings["regionofinterestenable"+r]=s;if(s===0){$("#configButton"+r).attr("disabled","disabled");$("#regions"+r).hide()}else{if(s===1){$("#configButton"+r).removeAttr("disabled");$("#regions"+r).show()}}}}),makeButton("Configure",{id:"configButton"+r,"class":"btn"}).click(function(){var v={valid:true,msg:" "};$.each(["r1","r2","r3"],function(y,x){advVideoValidateInputField(v,"#regStr"+r+x+"x","#regStr"+r+x+"y","#regStr"+r+x+"w","#regStr"+r+x+"h",r)});if(v.valid){h=getPluginWidthAndHeight(advVideoSettings,getMainBarHalfAvailableSpace({x:165,y:180}),r);d(r);var u=[parseDecimal(advVideoSettings["str"+r+"x1"]),parseDecimal(advVideoSettings["str"+r+"y1"]),parseDecimal(advVideoSettings["str"+r+"w1"]),parseDecimal(advVideoSettings["str"+r+"h1"])].join(":");var t=[parseDecimal(advVideoSettings["str"+r+"x2"]),parseDecimal(advVideoSettings["str"+r+"y2"]),parseDecimal(advVideoSettings["str"+r+"w2"]),parseDecimal(advVideoSettings["str"+r+"h2"])].join(":");var s=[parseDecimal(advVideoSettings["str"+r+"x3"]),parseDecimal(advVideoSettings["str"+r+"y3"]),parseDecimal(advVideoSettings["str"+r+"w3"]),parseDecimal(advVideoSettings["str"+r+"h3"])].join(":");var w=[u,t,s].join(",");addVideoDiv(advVideoSettings,"#videoAdvancedInModal"+(o+1),h.width,h.height,"videoAdv"+r);videoManager.setProperty("totalROIs",3,"videoAdv"+r);videoManager.setProperty("streamResolution",getStreamResolution(advVideoSettings,r),"videoAdv"+r);videoManager.setProperty("ROIs",w,"videoAdv"+r);videoManager.setProperty("uimode",3,"videoAdv"+r);videoManager.play(advOrigVideoSettings.getStreamUrl(o),"videoAdv"+r)}else{showOverlaidMessageModal("Message",v.msg)}})]),mkElem("div",{id:"ROIModal"+r}),mkElem("div",{id:"regions"+r})]}logDebug("name is ..",n,n.search("JPEG"),q);if(n.search("JPEG")===-1){return p(q)}else{return[mkElem("h4",{},"No Advanced Settings for JPEG is available in this version")]}}$.ajax({url:IPNC.serverURL+"ini.htm",success:function(q){advOrigVideoSettings=initVideoSettings(parseINI(q));advVideoSettings=$.extend({},advOrigVideoSettings);h=getPluginWidthAndHeight(advVideoSettings,getMainBarAvailableSpace(null,g),1);var r=mkElem("div",{id:"advLeftPanelId","class":"span7"},[mkElem("br",{},""),mkPrependedInput("Camera",{id:"inputCamera",value:advVideoSettings.title,disabled:"disabled"},"icon-camera"),mkElem("div",{id:"advTabs"})]);var o=mkElem("div",{id:"advRrightPanelId","class":"span5"},centerWrap(mkElem("div",{id:"videoAdvanced"})));var p=mkElemClass("div","form-horizontal row-fluid",[r,o]);var n=mkElemClass("div","form-actions",[mkButton("Ok","btn-primary",mkVerboseSaver(saveVideoAdvSettings,"Video Advanced settings saved to "+advVideoSettings.title,openVideoAdvanced))," ",mkButton("Cancel",null,openVideoAdvanced),"  ",mkButton("Back",null,curry(closeAdvancedVideo,openVideo))]);$("#mainbar").html(mkElem("div",{id:"submain"},[mkElem("h2",{},"Video > Advanced"),mkUpdateModal(),p,mkSaveStatusDiv(),n]));showPendingStatus();$("#advTabs").html(mkTabbable("advStreamTabs",$.map(range(advVideoSettings.videocodec+1),function(s){return{label:"Stream "+(s+1),target:"stream"+s,content:l(s),click:function(){h=getPluginWidthAndHeight(advVideoSettings,getMainBarAvailableSpace(null,g),s+1);addVideoDiv(advVideoSettings,"#videoAdvanced",h.width,h.height,"advVideo");videoManager.play(advOrigVideoSettings.getStreamUrl(s))}}})));$.each(range(advVideoSettings.videocodec+1),function(s){if(advVideoSettings["regionofinterestenable"+(s+1)]===0){$("#configButton"+(s+1)).attr("disabled","disabled");$("#regions"+(s+1)).hide()}else{if(advVideoSettings["regionofinterestenable"+(s+1)]===1){$("#regions"+(s+1)).show();$("#configButton"+(s+1)).removeAttr("disabled")}}$("#regions"+(s+1)).html(k(s+1));$.each(["#init"+(s+1),"#min"+(s+1),"#max"+(s+1)],function(u,t){validateNumericField(t)});$.each(["x","y","w","h"],function(t,u){$.each(["r1","r2","r3"],function(w,v){validateNumericField("#regStr"+(s+1)+v+u)})});validateNumericField("#packet"+(s+1));validateNumericField("#IpRatio"+(s+1))});$("#mainbar .nav-tabs a").tab("show");$("#advStreamTabs a:first").tab("show");logDebug("playing from loc 1");addVideoDiv(advVideoSettings,"#videoAdvanced",h.width,h.height,"advVideo");videoManager.play(advVideoSettings.getStreamUrl(0));$("#submain").css({height:"650px"});$("#sideBarId").css({height:$("#submain").height()-10})}})}function advVideoValidateInputField(a,l,k,m,i,e){var c=parseDecimal($(l).val());var b=parseDecimal($(k).val());var d=parseDecimal($(m).val());var n=parseDecimal($(i).val());var f=getStreamSize(advVideoSettings,e);var g="Please enter valid X, Y, Width, Height for stream"+e;var j="Please enter valid width and height for stream"+e+" Min W : "+(8/e)+" Min H : "+(8/e);if(!(c+d<=f.width&&b+n<=f.height)){a.valid=false;a.msg=g;return}else{if(n<=2&&(c>2||b>2)){a.valid=false;a.msg=j;return}else{if((d>0&&n===0)||(n>0&&d===0)){a.valid=false;a.msg=j;return}}}}function validateQPMinMax(b,a){if(parseDecimal($("#min"+b).val())>parseDecimal($("#max"+b).val())){a.valid=false;a.msg="QP value Max sholud be greater than min"}}function packetValidation(c,b){var a=$("#packet"+c).val();var d="Packet size should allow values between 0 to 100(In stream "+c+")";if(a>100){b.valid=false;b.msg=d}}function saveVideoAdvSettings(d){var a=curry(delayedExec,d);var c={valid:true,msg:""};$.each(range(advVideoSettings.videocodec),function(e){var f=e+1;validateQPMinMax(f,c);packetValidation((f),c);$.each(["r1","r2","r3"],function(h,g){advVideoValidateInputField(c,"#regStr"+f+g+"x","#regStr"+f+g+"y","#regStr"+f+g+"w","#regStr"+f+g+"h",f)})});var b=curry(checkReload,function(f,e){if(f){videoManager.stopAndHide();$("#updateModal").modal({backdrop:"static",keyboard:false});new modalProgress(e,function(){$("#updateModal").modal("hide");setTimeout(d,100)})}else{setTimeout(d,100)}});if(c.valid){sendSettings(advVideoSettings,["ipratio1","forceiframe1","qpinit1","qpmin1","qpmax1","meconfig1","packetsize1","regionofinterestenable1","str1x1","str1y1","str1w1","str1h1","str1x2","str1y2","str1w2","str1h2","str1x3","str1y3","str1w3","str1h3"],function(){if(advVideoSettings.videocodec>0){sendSettings(advVideoSettings,["ipratio2","forceiframe2","qpinit2","qpmin2","qpmax2","meconfig2","packetsize2","regionofinterestenable2","str2x1","str2y1","str2w1","str2h1","str2x2","str2y2","str2w2","str2h2","str2x3","str2y3","str2w3","str2h3"],function(){if(advVideoSettings.videocodec>1){sendSettings(advVideoSettings,["ipratio3","forceiframe3","qpinit3","qpmin3","qpmax3","meconfig3","packetsize3","regionofinterestenable3","str3x1","str3y1","str3w1","str3h1","str3x2","str3y2","str3w2","str3h2","str1x3","str3y3","str3w3","str3h3"],b)}else{b()}})}else{b()}})}else{showOverlaidMessageModal("Message",c.msg)}}function initAdvancedVideo(){advOrigVideoSettings={};advVideoSettings={}}function closeAdvancedVideo(a){if(isDifferent(advOrigVideoSettings,advVideoSettings)){videoManager.hideAll();showConfirmationModal("Message","Do you want to save the changes?",curry(saveVideoAdvSettings,function(){initAdvancedVideo();a()}),function(){initAdvancedVideo();a()},true)}else{a()}};