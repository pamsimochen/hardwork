var smartAnlySettings={refreshAllowed:true,eventList:[],features:{TamperDetection:{bitNum:0},IMotionDetection:{bitNum:1},StreamingMedia:{bitNum:2},TripZone:{bitNum:3},ObjCounting:{bitNum:4}},schedule:{}};function openSmartAnalytics(){var u={};timerManager.clear();function d(X){timerManager.clear();X()}var O=25;smartAnlySettings.eventList=[];function N(X){return mkBitMap(X,function(Y,Z){return setBit(Z.bitNum,Z.enabled)})}function V(ad,Z){logDebug("toggling",ad,"to",Z);smartAnlySettings.refreshAllowed=false;var ac=smartAnlySettings.features;var Y=N(ac);if(ad!=="TamperDetection"){$.each(ac,function(ae,af){if(ae!=="TamperDetection"){af.enabled=false}})}var X=false;if(ad==="Schedule"){X=true;smartAnlySettings.schedule.enabled=Z}else{var ab=ac[ad];ab.enabled=Z;X=Z&&(ad!=="TamperDetection");if(X){smartAnlySettings.schedule.enabled=false}if(!smartAnlySettings.schedule.enabled){}}var aa=function(af){var ae=N(ac);if(ae!=Y){$.ajax({url:IPNC.serverURL+"vb.htm?dmvacfgctdimdsmostzoc="+ae,success:function(ah){var ag=parseVBResponse(ah);smartAnlySettings.refreshAllowed=true;if(ag.dmvacfgctdimdsmostzoc){r()}else{logError("Unexpected error from camera")}}})}else{smartAnlySettings.refreshAllowed=true}};P(ac.IMotionDetection.enabled,ac.TripZone.enabled,ac.StreamingMedia.enabled,ac.ObjCounting.enabled);if(X){logDebug("Updating schedule",smartAnlySettings.schedule.enabled);$.ajax({url:IPNC.serverURL+"vb.htm?dmvascheduleenable="+setBit(0,smartAnlySettings.schedule.enabled),success:aa})}else{aa()}}function w(X){$("#tabTargetMessageWindow").text(X)}var n="No Event Installed";function I(){w(n)}function L(X,Y){return X.hover(curry(w,Y),I)}function x(Z,Y,X){return mkElemClass("div","btnContainer",[L(mkInlineCheckButtonElem(Z,"check"+Y,{change:curry(V,Y)}),"Click to enable / disable "+Z),L(mkElem("img",{"class":"configure",src:"img/cog.png"}).click(function(){$(this).tooltip("hide");X();smartAnlySettings.prevCfg=-1}).tooltip({title:"Configure "+Z}),"Click to configure "+Z)])}function P(ab,Z,aa,X){var Y=function(){videoManager.setProperty("uimode",PLUGIN_UI_MODE.EM,"videoDMVA");setOverlayProperties(smartVideoSettings,"videoDMVA")};if(ab){Y=iMotionInitPlugin}else{if(Z){Y=tripZoneInitPlugin}else{if(aa){Y=sMetaInitPlugin}else{if(X){Y=objCountInitPlugin}}}}Y(smartVideoSettings,u.width,u.height,"videoDMVA");c()}function r(){if(smartAnlySettings.refreshAllowed){$.ajax({url:IPNC.serverURL+"vb.htm?dmvaeventstart=1&paratest=dmvaevent&paratest=dmvaeventlisttimestamp&paratest=dmvaeventlistarchiveflag&paratest=dmvaeventlisteventtype&paratest=dmvacfgctdimdsmostzoc&paratest=dmvaeventlisteventdetails",success:function(ab){var ah=parseVBResponse(ab);var ac=parseDecimal(ah.dmvacfgctdimdsmostzoc);if(smartAnlySettings.prevCfg!==ac){smartAnlySettings.prevCfg=ac;var Y=isBitSet(ac,0);var af=isBitSet(ac,1);var ae=isBitSet(ac,2);var ag=isBitSet(ac,3);var Z=isBitSet(ac,4);var aa=smartAnlySettings.schedule.enabled;var ad=!aa;P(af,ag,ae,Z);var X=[];if(Y){X.push("Camera Tamper Detection")}if(af){X.push("Intelligent Motion Detection")}else{if(ag){X.push("Trip Zone")}else{if(ae){X.push("Streaming Meta")}else{if(Z){X.push("Object Counting")}}}}n=X.length>0?X.join(" and ")+" installed":"No event installed";I();checkMarkInput("#checkTamperDetection",Y);checkMarkInput("#checkIMotionDetection",af);checkMarkInput("#checkStreamingMedia",ae);checkMarkInput("#checkTripZone",ag);checkMarkInput("#checkObjCounting",Z);enableInput("#checkIMotionDetection",ad);enableInput("#checkStreamingMedia",ad);enableInput("#checkTripZone",ad);enableInput("#checkObjCounting",ad);checkMarkInput("#checkSchedule",aa)}j(1,ah)}})}}function f(){$.ajax({url:IPNC.serverURL+"vb.htm?paratest=sdinsert",success:function(Y){var X=parseVBStatusResponse(Y).sdinsert;logDebug("SD Card status "+X);H(X)}})}function H(X){var Y="An Unknown Error has occurred";switch(X){case"0":Y="Please insert SD Card.";break;case"1":Y="Please mount SD Card.";break;case"3":Y=null;break;default:}if(Y!==null){showOverlaidMessageModal("Message",Y)}else{i()}}function i(){var Z=S();if(Z.length===0){showOverlaidMessageModal("Message","No event is selected from the list.")}else{var X=window.location.protocol+"//"+window.location.host+"/";var Y=IPNC.debugUserCreds?IPNC.serverURL:X;var aa=[];$.each(Z,function(ab,ac){aa.push(Y+"/sdget.htm?FILE="+ac.filepath)});g(aa)}}function F(Y){var X=Y.pop();if(X){logDebug("About to delete event",X.idx);$.ajax({url:IPNC.serverURL+"vb.htm?dmvaeventdeleteindex="+X.idx,success:function(Z){F(Y)}})}else{o();Q(1)}}function S(){var X=[];$.each(smartAnlySettings.eventList,function(Y,Z){if(Z.isSelected){X.push(Z)}});return X}function e(){var X=S();if(X.length===0){showOverlaidMessageModal("Message","No event is selected from the list.")}else{F(X)}}function U(){$.ajax({url:IPNC.serverURL+"vb.htm?dmvaeventdeleteall=1",success:function(X){logDebug("Deleted All events");Q(1)}})}function a(){$("#eventListTable input").removeAttr("checked");$.each(smartAnlySettings.eventList,function(X,Y){Y.isSelected=false})}function c(){var X=["enableMetaOverlay","enableTsOverlay","enableZoneOverlay","enableROIOverlay"];$.each(X,function(Y,aa){var Z=isBitSet(smartVideoSettings.dmvadisplayoptions,Y);videoManager.setProperty(aa,Z?1:0)})}var C=5;function t(Y,aa,Z,X){return mkCheckButtonElem(Y,aa,{checked:isBitSet(smartVideoSettings.dmvadisplayoptions,Z),change:function(ab){videoManager.setProperty(X,ab?1:0);smartVideoSettings.dmvadisplayoptions=mkBitMap(range(0,C),function(ad,ae){if(ad===Z){return setBit(Z,ab)}else{var ac=setBit(ad,true);return smartVideoSettings.dmvadisplayoptions&ac}});logDebug("display options",smartVideoSettings.dmvadisplayoptions.toString(2));$.ajax({url:IPNC.serverURL+"vb.htm?dmvadisplayoptions="+smartVideoSettings.dmvadisplayoptions})}})}var E=5;var h=3;function p(X,aa,Z){function Y(){l();$.ajax({url:IPNC.serverURL+"vb.htm?dmvaeventrecordingvame="+smartVideoSettings.dmvaeventrecordingvame})}return mkCheckButtonElem(X,aa,{checked:isBitSet(smartVideoSettings.dmvaeventrecordingvame,Z),change:function(ac){logDebug("change",X,ac);var ab=(Z===h)?ac:isBitSet(smartVideoSettings.dmvaeventrecordingvame,h);smartVideoSettings.dmvaeventrecordingvame=mkBitMap(range(0,E),function(ae,af){if(ae===Z){return setBit(Z,ac)}else{var ad=setBit(ae,ab);return smartVideoSettings.dmvaeventrecordingvame&ad}});logDebug("event recording options",smartVideoSettings.dmvaeventrecordingvame.toString(2));if(!ac&&h===Z){showOverlaidMessageModal("Message","Event recording will be disabled.",Y)}else{Y()}}})}function l(){var Y=isBitSet(smartVideoSettings.dmvaeventrecordingvame,h);var X="#checkAudio, #checkMetadata, #checkEventLog";if(!Y){checkMarkInput(X,false)}}var T=-1;var R=[];function b(Y){var X=R.length-1;if(Y==X){return{nextItemPresent:false}}else{return{nextItemPresent:true,nextItem:Math.min(X,Y+1)}}}function J(Y){var X=b(T);if(X.nextItemPresent){T=X.nextItem;$("#playStatus").text("[Playing Selected Event "+(b(T).nextItem+1)+" / "+R.length+" ]")}}function g(X){T=-1;enableInput("#btnBack, #btnPlayPause, #btnStop",true);$(".btnLive").show();$("#btn1xdisp").hide();$("#playStatus").text("[Playing Selected Event 1 / "+X.length+" ]");W(true);smartAnlySettings.refreshAllowed=false;videoManager.setProperty("uimode",PLUGIN_UI_MODE.EM,"videoDMVA");R=videoManager.playAll(X);logDebug("itemIds",R.join(","))}function z(){videoManager.stop();enableInput("#btnBack, #btnPlayPause, #btnStop",false);$(".btnLive").hide();$("#btn1xdisp").show();$("#playStatus").text("[Playing Live]");smartAnlySettings.refreshAllowed=true;var Y=smartAnlySettings.prevCfg;var aa=isBitSet(Y,0);var ac=isBitSet(Y,1);var ab=isBitSet(Y,2);var Z=isBitSet(Y,3);var X=isBitSet(Y,4);P(ac,Z,ab,X);playFirstStream()}function s(){videoManager.playItem(R[b(T).nextItem]);W(true)}var D=1;function W(X){if(X){D=0;$("#btnPlayPause i").removeClass("icon-ipnc-play-active").addClass("icon-ipnc-pause-active")}else{D=1;$("#btnPlayPause i").removeClass("icon-ipnc-pause-active").addClass("icon-ipnc-play-active")}}function M(){if(D===2){D=0;videoManager.playItem(R[b(T).nextItem])}else{W(D===1);videoManager.togglePause()}}function k(){var X=b(T+1);logDebug("In stop",X);if(X.nextItemPresent&&X.nextItem!==T){videoManager.stopNoClear();videoManager.playItem(R[X.nextItem]);J();W(true)}else{D=2;videoManager.stopNoClear();W(false)}}function B(){videoManager.stop();$("#mainbar").html(mkElem("div",{},[mkElemClass("div","pull-right",mkButton("Close 1x View","btnClose1X",openSmartAnalytics)),mkBreak(),mkBreak(),mkElemId("div","videoAnchorDMVA1X")]));var Y=$(window).height()-$("#videoAnchorDMVA1X").offset().top-20;addVideoDiv(smartVideoSettings,"#videoAnchorDMVA1X",$("#mainbar").width(),Y,"videoDMVA");videoManager.registerVLCEvent("MediaPlayerEndReached",J);var X=getStreamResolution(smartVideoSettings);logDebug("resolution is ",X);videoManager.setProperty("streamResolution",X);videoManager.setProperty("uimodeAlt",PLUGIN_UI_MODE.ONEX);P(smartAnlySettings.features.IMotionDetection.enabled,smartAnlySettings.features.TripZone.enabled,smartAnlySettings.features.StreamingMedia.enabled,smartAnlySettings.features.ObjCounting.enabled);playFirstStream()}function K(){u=getPluginWidthAndHeight(videoSettings,getMainBarHalfAvailableSpace({x:10,y:10}),1);var af=mkElemClass("div","form",[t("Enabled zones","checkEnabledZones",2,"enableZoneOverlay"),t("Time Stamp","checkTimestamp",1,"enableTsOverlay"),t("Metadata Overlay","checkMetadataOverlay",0,"enableMetaOverlay"),t("Region Of Interest","checkRegionOfInterest",3,"enableROIOverlay")]);var ab=mkElemClass("div","form",[p("Video","checkVideo",3),p("Audio","checkAudio",2),p("Metadata","checkMetadata",1),p("Event Log","checkEventLog",0)]);var ae=centerWrap(mkElemClass("div","liveVideoView",[mkElemId("div","videoAnchorDMVA"),mkElemClass("div","liveControls pull-right",[mkElemId("span","playStatus"),mkSpace(),mkButton("Live","btnLive",z),mkSpace(),mkIconButton("icon-ipnc-back-active","Back","btnBack",s),mkSpace(),mkIconButton("icon-ipnc-play-active","Play/Pause","btnPlayPause",M),mkSpace(),mkIconButton("icon-ipnc-stop-active","Stop","btnStop",k),mkSpace(),mkIconButton("icon-ipnc-display1x-active","Display 1x","btn1xdisp",curry(d,B))])]));var aa=mkElem("div",{id:"smartLeftPanel","class":"span6"},[ae,mkTable([],[[x("Tamper Detection","TamperDetection",openTamperDetection),x("iMotion Detection","IMotionDetection",curry(d,openIMotionDetection)),x("Streaming Metadata","StreamingMedia",curry(d,openStreamMeta))],[x("Schedule","Schedule",curry(d,openDMVASchedule)),x("Trip Zone","TripZone",curry(d,openTripZone)),x("Object Counting","ObjCounting",curry(d,openObjectCounting))]],{tableClass:"toggleButtonTable"}),mkElemClass("div","row-fluid",[mkElemClass("div","span6",createTab("tabDisplay","Display","tabTargetDisplay",af)),mkElemClass("div","span6",createTab("tabEvenRecording","Event Recording","tabTargetEventRecording",ab))])]);var Z=["Jan","Feb","Mar","Apr","May","June","Jul","Aug","Sep","Oct","Nov","Dec"];var ad=mkTable([],[[mkIconButton("icon-ipnc-play-active","Play/Pause","btnEventListPlayPause",f),mkIconButton("icon-ipnc-delete-active","Delete","btnEventListDelete",e),mkIconButton("icon-ipnc-watch","Mail","btnEventListMail"),mkIconButton("icon-ipnc-search-inactive","Search","btnEventListSearch"),"Start: ",mkSelectionElem("selectStartMonth",["-- "].concat(Z),{selectClass:"input-mini"}),mkSelectionElem("selectStartDay",["-- "].concat($.map(range(31),function(ah,ag){return paddingZero(ag+1)})),{selectClass:"input-mini"}),"Time: ",mkSelectionElem("selectStartHour",$.map(range(24),function(ah,ag){return paddingZero(ag)}),{selectClass:"input-mini"}),mkSelectionElem("selectStartMin",$.map(range(60),function(ah,ag){return paddingZero(ag)}),{selectClass:"input-mini"})],[null,null,null,null,"End: ",mkSelectionElem("selectEndMonth",["-- "].concat(Z),{selectClass:"input-mini"}),mkSelectionElem("selectEndDay",["-- "].concat($.map(range(31),function(ah,ag){return paddingZero(ag+1)})),{selectClass:"input-mini"}),"Time: ",mkSelectionElem("selectEndHour",$.map(range(24),function(ah,ag){return paddingZero(ag)}),{selectClass:"input-mini"}),mkSelectionElem("selectEndMin",$.map(range(60),function(ah,ag){return paddingZero(ag)}),{selectClass:"input-mini"})]],{tableClass:"actionControlTable zero-border"});var ac=mkElem("div",{id:"smartRightPanel","class":"span6"},mkElemClass("div",null,[createTab("tabEventList","Event List","tabTargetEventList",[mkElem("div",{id:"eventListTable",style:"width: 100%; height:384px; overflow-x:hidden; overflow-y:scroll !important"},mkElemClass("div","loadingIndicator well",["Please Wait. Loading Event List... ",mkElem("img",{src:"img/ajax-loader-arrow.gif"})])),mkElem("p",{},"Action"),ad],[mkButton("Delete All Events","pull-right",U),mkButton("Clear All","pull-right",a)],"eventList-overflow"),mkBreak(),createTab("tabMessageWindow","Message Window","tabTargetMessageWindow","No event Installed")]));var Y=mkElemClass("div","row-fluid",[aa,ac]);var X=mkElemClass("div","form-actions",[mkButton("Advanced",null,openDmvaAdvancedSettings)," ",mkButton("Return to Live Video",null,q)]);hideSideBar();$("#mainbar").html(mkElem("div",{},[mkElem("h2",{},"Smart Analytics Event Monitoring"),mkElem("div",{id:"modalContainer"}),Y,mkBreak(),X]));$("#mainbar .nav-tabs a").tab("show");addVideoDiv(smartVideoSettings,"#videoAnchorDMVA",u.width,u.height,"videoDMVA");P(false,false,false,false);z();l();$.each(["#checkAudio","#checkMetadata","#checkEventLog"],function(ag,ah){$(ah).click(function(aj){var ai=isBitSet(smartVideoSettings.dmvaeventrecordingvame,h);if(!ai){$(ah).attr("checked",true);showOverlaidMessageModal("Message","Please enable video",function(){$(ah).removeAttr("checked")})}})});Q(1,curry(timerManager.createSeqIntervalTimerCallImmediate,r,IPNC.dmvaRefreshTime))}var G=["IMD","Trip zone","Object Count","Tamper"];function y(Y){var X=[mkElem("img",{src:"img/video.jpg"})];if(Y.match(/AUD/)){X.push(mkElem("img",{src:"img/audio.jpg"}))}if(Y.match(/MET/)){X.push(mkElem("img",{src:"img/meta.jpg"}))}return X}function A(X){return mkTable(["Select","Timestamp","Archive","Event Type","Event Details"],map(X,function(Y,Z){return[mkCheckButtonElem("","checkEvent"+Y,{change:function(aa){Z.isSelected=aa}}),Z.timestamp,Z.archiveImg,Z.type,Z.filepath+Z.timestamp+" "+Z.details]}),{tableClass:"table-striped"})}function m(){$("#eventListTable").html(A(smartAnlySettings.eventList))}function v(){smartAnlySettings.prevEventList=smartAnlySettings.eventList;smartAnlySettings.eventList=[]}function o(){v();m()}function j(ac,X,Z){function aa(){m();smartAnlySettings.prevEventList=[];logDebug("Finished fetching event list. Total entries:",ac-1);if(Z){Z()}}if((typeof(X.dmvaevent)!=="string")||(X.dmvaevent.length===0)){aa()}else{var Y={dmvaevent:X.dmvaevent,filepath:splitOnce(X.dmvaevent,":")[0],type:G[X.dmvaeventlisteventtype],timestamp:X.dmvaeventlisttimestamp,archiveImg:y(X.dmvaevent),isSelected:false,idx:ac,details:X.dmvaeventlisteventdetails};var ab=false;$.each(smartAnlySettings.eventList,function(ad,ae){if(ae.filepath===Y.filepath){ab=true}});if(!ab){logDebug("Got new event",ac,":",Y);if(ac===1){v()}$.each(smartAnlySettings.prevEventList,function(ae,ad){if(ad.filepath===Y.filepath){Y.isSelected=ad.isSelected}});smartAnlySettings.eventList.push(Y);if(ac<IPNC.maxEventList){Q(ac+1,Z)}else{logDebug("Stopping after reaching event list limit.");aa()}}}}function Q(Y,X){if(Y===1){smartAnlySettings.eventList=[]}$.ajax({url:IPNC.serverURL+"vb.htm?dmvaeventstart="+Y+"&paratest=dmvaevent&paratest=dmvaeventlisttimestamp&paratest=dmvaeventlistarchiveflag&paratest=dmvaeventlisteventtype&paratest=dmvaeventlisteventdetails",success:function(aa){var Z=parseVBResponse(aa);j(Y,Z,X)}})}function q(){showSideBar();navigatorObj.switchTo(0);videoManager.stop();smartAnlySettings.prevCfg=-1}$.ajax({url:IPNC.serverURL+"ini.htm",success:function(X){var Y=parseINI(X);videoSettings=initVideoSettings(Y);smartVideoSettings=$.extend({},sMetaConstants.zoneEnableWorkAround,videoSettings);smartAnlySettings.schedule.enabled=videoSettings.dmvascheduleenable===1;K()}})};