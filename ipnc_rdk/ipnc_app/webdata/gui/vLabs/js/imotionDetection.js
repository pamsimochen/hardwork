var origIMotionSettings={};var iMotionSettings={};var iMotionConstants={MAX_ZONES:4,MAX_POLY_VERTICES:16,FOV_MSG:"Since no zone has been explicitly defined, an alert event will be signaled when any object motion is detected within the entire field of view. Press Save to accept or Cancel to return to the IMD Control Panel."};function windowMsg(b,a){var c="Object size, "+b+", "+a+": Enter the "+a+"imum width and height(in pexal) a "+b+". Alternately, use mouse to draw the largest rectangle that would tightly fit around a "+b+" appearing in the scene.";return c}function imdValidate(a){return chainValidatorCopy([{fieldName:"Vehicle",selector:"#vhclMinHghtId",selector1:"#vhclMaxHghtId",min:a.dmvaimdsmetavehicleminheightlimit,max:a.dmvaimdsmetavehiclemhaxheightlimit,field:"height",validator:validateMinMaxLimit},{fieldName:"Vehicle",selector:"#vhclMinWdthId",selector1:"#vhclMaxWdthId",min:a.dmvaimdsmetavehicleminwidthlimit,max:a.dmvaimdsmetavehiclemaxwidthlimit,field:"width",validator:validateMinMaxLimit},{fieldName:"People",selector:"#pplMinHghtId",selector1:"#pplMaxHghtId",min:a.dmvaimdsmetapersonminheightlimit,max:a.dmvaimdsmetapersonmaxheightlimit,field:"height",validator:validateMinMaxLimit},{fieldName:"People",selector:"#pplMinWdthId",selector1:"#pplMaxWdthId",min:a.dmvaimdsmetapersonminwidthlimit,max:a.dmvaimdsmetapersonmaxwidthlimit,field:"width",validator:validateMinMaxLimit}])}function saveiMotionDetSettings(c,d){var b=imdValidate(iMotionSettings);if(b.valid){var a=["dmvaimdnumzones","dmvaimdzone1_roi_numsides","dmvaimdzone2_roi_numsides","dmvaimdzone3_roi_numsides","dmvaimdzone4_roi_numsides"];sendSettings(iMotionSettings,a,function(){var e=iMotionSettings.dmvaimdnumzones;sendXYSettingsForZone(iMotionSettings,"imd",e,0,function(){sendSettings(iMotionSettings,["dmvaimdvehicleminwidth","dmvaimdvehicleminheight","dmvaimdvehiclemaxwidth","dmvaimdvehiclemaxheight","dmvaimdpersonminwidth","dmvaimdpersonminheight","dmvaimdpersonmaxwidth","dmvaimdpersonmaxheight","dmvaimdsensitivity","dmvaimdpresentadjust","dmvaimdzone_1_label","dmvaimdzone_2_label","dmvaimdzone_3_label","dmvaimdzone_4_label","dmvaimdzoneenable"],function(){if(c){logDebug("Saving to file:",iMotionSettings.dmvaimdsave);sendSettings(iMotionSettings,["dmvaimdsave"],curry(delayedExec,d))}else{delayedExec(d)}})})})}else{showOverlaidMessageModal("Message",b.msg)}}function iMotionInitPlugin(e,b,i,g){function f(k,j){var l=k.slice(0);var m=j-k.length;$.each(range(m),function(n,o){l.push([0,0])});return map(l,function(o,n){return n.join(":")}).join(";")}function a(j,k){return[j.length,k,f(j,iMotionConstants.MAX_POLY_VERTICES)].join(";")}setOverlayProperties(e,g);videoManager.setProperty("maxZones",iMotionConstants.MAX_ZONES,g);videoManager.setProperty("maxPolyVertices",iMotionConstants.MAX_POLY_VERTICES,g);var d=e.dmvaimdnumzones;var c=[];$.each(range(d),function(m){var k=m+1;var l=e["dmvaimdzone"+k+"_roi_numsides"];var j=map(range(l),function(o){var n=pad2(o+1);return[parseDecimal(e["dmvaimdzone"+k+"_x"+n]),parseDecimal(e["dmvaimdzone"+k+"_y"+n])]});c.push(a(j,e["dmvaimdzone_"+k+"_label"]))});videoManager.setProperty("polyArray",c.join(","),g);videoManager.setProperty("uimode",PLUGIN_UI_MODE.IMD,g);var h=new polyZoneConstructor(e,"imd",iMotionConstants.MAX_POLY_VERTICES,iMotionConstants.MAX_ZONES,iMotionConstants.FOV_MSG,b,i,PLUGIN_UI_MODE.IMD,g);h.updateZoneEnabledStates()}function openIMotionDetection(){var a={};var c;function b(){a=getPluginWidthAndHeight(videoSettings,getMainBarHalfAvailableSpace({x:10,y:10}),1);c=new polyZoneConstructor(iMotionSettings,"imd",iMotionConstants.MAX_POLY_VERTICES,iMotionConstants.MAX_ZONES,iMotionConstants.FOV_MSG,a.width,a.height,PLUGIN_UI_MODE.IMD,"videoIMD");var h=["dmvaimdvehicleminwidth","dmvaimdvehicleminheight","dmvaimdvehiclemaxwidth","dmvaimdvehiclemaxheight"];var o=["dmvaimdpersonminwidth","dmvaimdpersonminheight","dmvaimdpersonmaxwidth","dmvaimdpersonmaxheight","imdSensitivities","dmvaimdsensitivity","dmvaimdpresentadjust"];var i=mkElem("div",{id:"imotionleftPanel","class":"span7 row-fluid"},[centerWrap(mkElemId("div","videoAnchorIMD")),mkElemId("div","objTable",createTab("tabObj","IMD Settings","tabObjTarget",mkObjectTable(iMotionSettings,o,h,"videoIMD")))]);function k(){$("#imotionWindowMessage").text("Click on this button to define a polygon to represent a new region of interest")}function f(){$("#imotionWindowMessage").text("Click to delete a region of interest")}function l(){$("#imotionWindowMessage").text("Click all zones locally. Will be saved in the IPNC when 'Save Settings' button is clicked")}var q=[mkButton("Add Zone"," ",c.addZone).hover(k),"   ","  ",mkButton("Delete Zone","deleteZoneBtn",c.deleteZone).hover(f)," ",mkButton("Delete All","deleteAllZonesBtn",c.deleteAllZones).hover(l),mkBreak(),mkElemId("div","zoneTableAnchor")];var p=mkElem("div",{id:"imotionrightPanel","class":"span5"},[createTab("tabimotionZoneSettings","Zone Settings","tabStreamTargetimotionZoneSettings",q,mkElemClass("div","pull-right",[mkInlineSelectionInput("Load Settings","selectLoadSettings",iMotionSettings.loadNames,{selectedIndex:iMotionSettings.dmvaimdload,selectClass:"input-average"}),mkButton("Load","",curry(loadSelectedSetting,iMotionSettings,"dmvaimdload",openIMotionDetection))])),mkBreak(),messageWindowTab("imotionWindow")]);var n="iMotion Detection settings saved to "+iMotionSettings.title;var g=mkElemClass("div","form-horizontal form-inline row-fluid",[i,p]);var e=mkElemClass("div","form-actions",[mkElem("div",{id:"imdsaveDiv"}),mkButton("Apply Settings"," ",mkVerboseSaver(function(r){c.checkAndSave(curry(saveiMotionDetSettings,false,r))},n,openIMotionDetection))," ",mkButton("Save Settings"," ").click(function(){c.checkAndSave(curry(saveSettingsModal,"imd",curry(imdValidate,iMotionSettings)))})," ",mkButton("Return to Event Monitor").click(openSmartAnalytics)]);$("#sidebar").hide();$("#mainbar").removeClass("span9");$("#mainbar").html(mkElem("div",{},[mkElem("h2",{},"Intelligent Motion Detection Settings"),mkBreak(),g,mkBreak(),mkSaveStatusDiv(),e]));$("#mainbar .nav-tabs a").tab("show");playFirstStream();$("#imdsaveDiv").html(mkFileNameModal("imd",iMotionSettings,"dmvaimdloadnames",saveSettings,mkVerboseSaver(curry(saveiMotionDetSettings,true),n,openIMotionDetection),"imdSettings"));showPendingStatus();validateSettingsFileName("#inputFileNameimd");var m=["pplMinWdthId","pplMinHghtId","pplMaxWdthId","pplMaxHghtId"];var j=["vhclMinWdthId","vhclMinHghtId","vhclMaxWdthId","vhclMaxHghtId"];$.each(m,function(r,s){$("#"+s).hover(function(){var t=r<=1?"min":"max";$("#imotionWindowMessage").text(windowMsg("people",t))});validateNumericField("#"+s)});$.each(j,function(r,s){$("#"+s).hover(function(){var t=r<=1?"min":"max";$("#imotionWindowMessage").text(windowMsg("vehicle",t))});validateNumericField("#"+s)});var d=["pplViewChkId","pplModifyChkId","vhclViewChkId","vhclModifyChkId"];$.each(d,function(r,s){$("#"+s).hover(function(){var t=r<=1?"people":"vehicle";$("#imotionWindowMessage").text("Define object size (min, max) for  "+t)})});$("#selectSensitivityId").hover(function(){var r="Try Low sensitivity to improve performance in outdoor or challenging environments. High-sensitivity works best for fast moving objects in stable lighting environments.";$("#imotionWindowMessage").text(r)});addVideoDiv(iMotionSettings,"#videoAnchorIMD",a.width,a.height,"videoIMD");playFirstStream();iMotionInitPlugin(iMotionSettings,a.width,a.height,"videoIMD");videoManager.registerVLCEvent("onZoneCompleted",c.onZoneCompleted);videoManager.registerVLCEvent("onObjResized",curry(handleObjResize,"IMD Settings",iMotionSettings,"imd",o,h,"videoIMD"));c.updateZoneTable()}$.ajax({url:IPNC.serverURL+"ini.htm",success:function(d){var e=parseINI(d);videoSettings=initVideoSettings(e);origIMotionSettings=$.extend({},e,{imdSensitivities:e.dmvaimdsensitivityname.split(/;/),loadNames:parseLoadNames(e.dmvaimdloadnames)});iMotionSettings=$.extend({},origIMotionSettings);iMotionSettings.pplDefaultLimits=getObjectLimits(iMotionSettings,"imdsmeta","person",true);iMotionSettings.vhclDefaultLimits=getObjectLimits(iMotionSettings,"imdsmeta","vehicle",true);iMotionSettings.currScreen="imd";b()}})};