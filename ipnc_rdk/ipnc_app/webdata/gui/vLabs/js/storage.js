var origStorageSettings=null,storageSettings=null;function openStorage(){var h=7;function b(p,n,o){var m=mkElemClass("div","controls",n);if(o){m.append(mkElemClass("span","help-inline").text(o))}return mkElemClass("div","control-group",[mkElemClass("label","control-label control-label-wide control-label-left",p),m])}function e(o,n,q,p){var r=$.extend({type:"text"},n);var m=mkElemClass("div","input-prepend",[mkElemClass("span","add-on",mkIcon(q)),mkElem("input",r).change(p).keyup(p)]);return b(o,m)}function c(n,o,m){return n>=o&&n<=m}function l(m){var p=[mkElemClass("td","",mkElemClass("p","row-header",storageSettings.weekDayNames[m]))];var o=storageSettings.schedules;function n(u,r){var q=h-1;for(;q>=0;q--){var t=o[q];if(t.enabled){if(m===t.day&&(c(u,t.fromDecimal(),t.toDecimal())||c(r,t.fromDecimal(),t.toDecimal())||c(t.fromDecimal(),u,r))){return q}}}return"None"}$.each(range(25),function(r){var q="hour "+(r%6===0?"hour6":"");p.push(mkElemClass("td",q,mkElem("div",{})));if(r<24){$.each(range(4),function(u,w){var v=r+w*0.25;var s=n(v+0.001,v+0.2499);var t=mkElemClass("td","quarter",mkElemClass("div","schedMark"+s));if(s!=="None"){t.tooltip({title:o[s].formatToolTip()})}p.push(t)})}});return mkElem("tr",{},p)}function a(){return mkElem("table",{"class":"schedule-table",border:0,cellspacing:0},[mkElemClass("thead","",mkElem("tr",{},[mkElemClass("th"),mkElem("th",{colspan:30},mkElemClass("div","small","0.00")),mkElem("th",{colspan:30},mkElemClass("div","small","6.00")),mkElem("th",{colspan:30},mkElemClass("div","large","12.00")),mkElem("th",{colspan:30},mkElemClass("div","large","18.00")),mkElem("th",{colspan:30},mkElemClass("div","large","24.00"))])),mkElem("tbody",{},$.map(range(7),function(o,m){return l(o)}))])}function i(m){var o=$.trim(m.schedule).split(/\n/g);var n=m.dmvascheduledaynames.split(/;/g);return $.extend(m,{dayNames:n,weekDayNames:n.slice(0,7),scheduleStrs:o,FTPFileFormats:m.ftpfileformatname.split(/;/g),SDFileFormats:m.sdfileformatname.split(/;/g),schedules:$.map(o,function(z){var p=parseDecimal(z.slice(5,7)),v=parseDecimal(z.slice(7,9)),r=parseDecimal(z.slice(11,13)),y=parseDecimal(z.slice(13,15)),w=p+v/60,u=r+y/60,q=w+u,x=Math.floor(q),t=Math.round(60*(q-x));return{enabled:z.charAt(2)==="1",day:parseDecimal(z.charAt(4))-1,fromHr:p,fromMin:v,toHr:x,toMin:t,fromDecimal:function(){return this.fromHr+(this.fromMin/60)},toDecimal:function(){return this.toHr+(this.toMin/60)},formatToolTip:function(){return pad2(this.fromHr)+":"+pad2(this.fromMin)+" - "+pad2(this.toHr)+":"+pad2(this.toMin)}}})})}function f(m){return $.map(m,function(n){return mkElem("td",{},n)})}function d(m){$("#schedTopForm").show();storageSettings.schedules=m;$("#scheduleGrid").html(a())}function g(){var o=$.extend(true,{},storageSettings.schedules);$("#schedTopForm").hide();var q=$.map(range(24),function(r){return pad2(r)}),m=$.map(range(60),function(r){return pad2(r)});function n(){return mkElem("tbody",{},$.map(range(h),function(t){var u=o[t];var r={selectClass:"input-mini",disabled:!u.enabled,change:function(){u.fromHr=$("#selectFromHr"+t).get(0).selectedIndex;u.fromMin=$("#selectFromMin"+t).get(0).selectedIndex;var s=u.fromHr+(u.fromMin/60);u.toHr=$("#selectToHr"+t).get(0).selectedIndex;u.toMin=$("#selectToMin"+t).get(0).selectedIndex;var v=u.toHr+(u.toMin/60);if(v<s){u.toHr=u.fromHr;u.toMin=u.fromMin}$("#selectToHr"+t).get(0).selectedIndex=u.toHr;$("#selectToMin"+t).get(0).selectedIndex=u.toMin}};return mkElem("tr",{},f([mkCheckButtonElem("","checkSchedDay"+t,{checked:u.enabled,change:function(){u.enabled=!u.enabled;p()}}),mkElemClass("div","schedMarkSquare schedMark"+t),mkSelectionElem("selectDay"+t,storageSettings.weekDayNames,{selectClass:"input-medium",selectedIndex:u.day,disabled:!u.enabled,change:curry(updateFromCombo,u,"day","selectDay"+t)}),mkElemClass("p","timeLabel","From"),mkSelectionElem("selectFromHr"+t,q,$.extend({},r,{selectedIndex:u.fromHr})),mkSelectionElem("selectFromMin"+t,m,$.extend({},r,{selectedIndex:u.fromMin})),mkElemClass("p","timeLabel","To"),mkSelectionElem("selectToHr"+t,q,$.extend({},r,{selectedIndex:u.toHr})),mkSelectionElem("selectToMin"+t,m,$.extend({},r,{selectedIndex:u.toMin}))]))}))}function p(){$("#schedEditTable").html(n())}$("#scheduleGrid").html(mkElem("div",{},[mkElem("table",{id:"schedEditTable"},n()),centerWrap(mkElemClass("div","form-actions",[mkButton("Ok","btn-primary",curry(d,o))," ",mkButton("Cancel","",curry(d,storageSettings.schedules))," "]))]))}function k(){showConfirmationModal("Remove all schedules...","Are you sure?",function(){$.ajax({url:IPNC.serverURL+"vb.htm?delschedule=1",success:function(m){setTimeout(openStorage,100)}})},null,true)}function j(p){origStorageSettings=i(parseINI(p));storageSettings=$.extend({},origStorageSettings);logDebug("schedules",storageSettings.schedules);var r=centerWrap(mkElem("div",{"class":"form-actions",id:"schedTopForm"},[mkButton("Add Schedule","btn-success",g)," ",mkButton("Ok","btn-primary",mkVerboseSaver(saveStorageSettings,"Storage settings saved to "+storageSettings.title,openStorage))," ",mkButton("Cancel",null,openStorage)," ",mkButton("Remove all schedules","btn-danger",k)]));var m=origStorageSettings.sdinsert===3;var o="control-label control-label-wide control-label-left";var n=mkElemClass("div","form-horizontal form-inline offset2",mkElemClass("fieldset","",[e("Camera",{id:"inputCamera",value:storageSettings.title,disabled:"disabled","class":"input-medium"},"icon-camera",""),mkControlGroupAdvanced(mkCheckButtonElem("Upload via FTP","checkUploadFTP",{"class":o,checked:storageSettings.rftpenable===1,change:function(s){storageSettings.rftpenable=s?1:0;enableInput("#selectFTPFileFormat",s)}}),mkInlineSelectionInput("File Format ","selectFTPFileFormat",storageSettings.FTPFileFormats,{selectClass:"input-medium",disabled:storageSettings.rftpenable===0,selectedIndex:storageSettings.ftpfileformat,change:curry(updateFromCombo,storageSettings,"ftpfileformat","selectFTPFileFormat")}),{}),mkControlGroupAdvanced(mkCheckButtonElem("Save into Local Storage","checkSaveLocalStorage",{"class":o,disabled:!m,checked:storageSettings.sdrenable===1,change:function(s){storageSettings.sdrenable=s?1:0;enableInput("#selectSDFileFormat",s)}}),[mkInlineSelectionInput("File Format ","selectSDFileFormat",storageSettings.SDFileFormats,{selectClass:"input-medium",disabled:!m||storageSettings.sdrenable!==1,selectedIndex:storageSettings.sdfileformat,change:curry(updateFromCombo,storageSettings,"sdfileformat","selectSDFileFormat")}),mkRadioButtons("Storage Location","radioStorage",["SD/MMC",{label:"USB",disabled:true},{label:"NAND",disabled:true}],{selectedIndex:storageSettings.recordlocalstorage,callback:function(s){storageSettings.recordlocalstorage=s}})],{"class":m?"":"control-group-disabled"}),mkControlGroupAdvanced(mkRadioButtonElem("Schedule Expires After","radioExpiresAfter","radioGroupExpiry",{"class":o,checked:storageSettings.schedulerepeatenable===1,change:function(s){storageSettings.schedulerepeatenable=s?1:0;storageSettings.scheduleinfiniteenable=s?0:1;enableInput("#inputWeeks",s)}}),[mkElemClass("label",o,[mkInputElem({id:"inputWeeks","class":"input-micro",disabled:storageSettings.schedulerepeatenable!==1,value:storageSettings.schedulenumweeks,change:curry(updateFromInputHandleEmpty,storageSettings,"schedulenumweeks","inputWeeks")})," weeks"]),mkRadioButtonElem("Run infinite times","radioInfinite","radioGroupExpiry",{"class":"control-label control-label-left",checked:storageSettings.scheduleinfiniteenable===1,change:function(s){storageSettings.schedulerepeatenable=s?0:1;storageSettings.scheduleinfiniteenable=s?1:0;enableInput("#inputWeeks",!s);if(s){$("#inputWeeks").val(0);storageSettings.schedulenumweeks=0}}})],{})]));var q=centerWrap(mkElemClass("div","schedule-section",[mkElemClass("h3","","Schedule"),mkElem("div",{id:"scheduleGrid"})]));$("#mainbar").html(mkElem("div",{},[mkElem("h2",{},"Storage"),n,q,mkSaveStatusDiv(),r]));validateNumericField("#inputWeeks");d(origStorageSettings.schedules);showPendingStatus();adjustSidebarHeight()}$.ajax({url:IPNC.serverURL+"ini.htm",success:j})}function saveStorageSettings(d){logDebug("Saving settings");function a(e){var g=Math.floor(e);var f=Math.round(60*(e-g));return pad2(g)+pad2(f)+pad2(0)}function b(e){if((e.schedulerepeatenable===1)&&((e.schedulenumweeks<1)||(storageSettings.schedulenumweeks>52))){return{error:true,msg:"Number of weeks should be between 1 to 52"}}else{return{error:false}}}var c=b(storageSettings);if(c.error){showMessageModal("Message",c.msg)}else{sendSettings(storageSettings,["rftpenable","ftpfileformat","sdrenable","sdfileformat","recordlocalstorage","schedulerepeatenable","schedulenumweeks","scheduleinfiniteenable"],function(){var e=IPNC.serverURL+"vb.htm?";e+=map(storageSettings.schedules,function(f,g){if(g.hasOwnProperty("fromDecimal")){return"schedule="+pad2(f)+(g.enabled?"1":"0")+"0"+(g.day+1)+a(g.fromDecimal())+a(g.toDecimal()-g.fromDecimal())}}).join("&");logDebug("url",e);$.ajax({url:e,success:function(f){setTimeout(d,100)}})})}}function closeStorage(a){if(isDifferent(origStorageSettings,storageSettings)){showConfirmationModal("Message","Do you want to save the changes?",curry(saveStorageSettings,a),a,true)}else{a()}};