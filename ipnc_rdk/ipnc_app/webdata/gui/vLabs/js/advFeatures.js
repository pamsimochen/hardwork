var origAdvFtrSettings={};var advFtrSettings={};function getAdvFtrStreamSize(){return{Width:parseDecimal(advFtrSettings.streamwidth1),Height:parseDecimal(advFtrSettings.streamheight1)}}function saveAdvFtrSettings(c){function b(f,d){var e=$(d).val();if(e.length===0){return{valid:false,msg:"Please enter "+f+" confidence level"}}else{if(parseInt(e,10)<1||parseInt(e,10)>100){return{valid:false,msg:f+" confidence should be in 1-100 range"}}}return{valid:true}}var a=chainValidator([{fieldName:"Face Detection",selector:"#fdcflvl",validator:b},{fieldName:"Face Recognition",selector:"#frconfLevel",validator:b},{fieldName:"Region of Interest X",selector:"#inputX",validator:checkNotEmpty},{fieldName:"Region of Interest Y",selector:"#inputY",validator:checkNotEmpty},{fieldName:"Region of Interest W",selector:"#inputW",validator:checkNotEmpty},{fieldName:"Region of Interest H",selector:"#inputH",validator:checkNotEmpty}]);if(a.valid){sendSettings(advFtrSettings,["fdconflevel","fddirection","fdetect","fdh","fdw","fdx","fdy","frconflevel","frdatabase","frecognition","maskoptions","privacymask"],function(){checkReload(function(e,d){if(e){$("#updateModal").modal({backdrop:"static",keyboard:false});new modalProgress(d,function(){$("#updateModal").modal("hide");delayedExec(c)})}else{delayedExec(c)}})})}else{showOverlaidMessageModal("Message",a.msg)}}function openAdvFeatures(){var d={};function e(n){var m=$.map(n.split(""),function(p,o){return padPrefix(parseInt(p,16).toString(2),"0",4).split("").reverse()});return m.join(",")}function b(o){var n=0;var m=group(o.split(","),4);$.each(m,function(p,r){var q=0;$.each(r,function(t,s){q|=parseDecimal(s)<<t});n|=q<<(2-p)*4});return n.toString(16).toUpperCase()}function f(m){var o="";for(var n=0;n<3-m;n++){o=o+"0"}return o}function h(){var m=b(videoManager.getProperty("motionBlocks","videoMotion"));advFtrSettings.motionblock=f(m.length)+m;logDebug("mblock is ",m);sendSettings(advFtrSettings,["motionblock","motioncenable","motioncvalue","motionsensitivity"],function(){$("#motionDetModal").modal("hide").remove();showOverlaidMessageModal("Message","Saved successfully",curry(delayedExec,openAdvFeatures))})}function l(){function s(){videoManager.setProperty("motionBlocks",map(range(12),function(u){return 1}).join(","),"videoMotion")}function q(){logDebug("motion black is ",map(range(12),function(u){return 0}).join(","));videoManager.setProperty("motionBlocks",map(range(12),function(u){return 0}).join(","),"videoMotion")}function m(){logDebug("setCurrentTiles are ",e(advFtrSettings.motionblock));videoManager.setProperty("motionBlocks",e(advFtrSettings.motionblock),"videoMotion")}videoManager.hideAll();var o=mkElem("div",{id:"configId"},[centerWrap(mkElem("div",{id:"videoAnchorMotion","class":"bttm"})),mkButton("Select All").click(s),mkButton("Clear All").click(q),mkButton("Restore").click(m),mkBreak(),mkElemClass("div","form-inline",[mkElem("label",{},"Sensitivity"),mkInlineRadioButtonElem("","sensitivtyId","Group",{checked:advFtrSettings.motioncenable===0,change:function(u){if(u){advFtrSettings.motioncenable=advFtrSettings.motioncenable===1?0:1}}}),mkInlineSelectionInput("","selectSensitivty",advFtrSettings.motions,{selectClass:"input-medium",selectedIndex:advFtrSettings.motionsensitivity,change:curry(updateFromCombo,advFtrSettings,"motionsensitivity","selectSensitivty")}),mkInlineRadioButtonElem("Customized Thresold","customisedId","Group",{checked:advFtrSettings.motioncenable===1,change:function(u){if(u){advFtrSettings.motioncenable=advFtrSettings.motioncenable===1?0:1}}}),mkInlineInput({id:"motioncvalue",value:advFtrSettings.motioncvalue,"class":"input-micro",label:"",maxlength:2,change:curry(updateFromInputHandleEmpty,advFtrSettings,"motioncvalue","motioncvalue")})])]);function p(){videoManager.stop("videoMotion");$("#motionDetModal").modal("hide").remove();openAdvFeatures()}var n=mkElem("div",{},[mkButton("Ok","btn-primary").click(h)," ",mkButton("Cancel"," ").click(p)]);var t=mkModalElem("motionDetModal","",mkElem("h3",{},"Motion Detection"),o,n,standardModalOptions,true,p);var r={width:$("#motionDetModal").width(),height:$("#motionDetModal").height()+50};d=getPluginWidthAndHeight(advFtrSettings,r,1);addVideoDiv(videoSettings,"#videoAnchorMotion",d.width,d.height,"videoMotion");m();videoManager.setProperty("uimode",PLUGIN_UI_MODE.MTN,"videoMotion");videoManager.play(videoSettings.getStreamUrl(0),"videoMotion");validateNumericField("#motioncvalue")}function i(){videoManager.stop("videoFaceDet");$("#faceDetModal").modal("hide").remove();videoManager.showAll()}function g(){return mkControlGroup("Region of Interest",mkElemClass("div","form-inline",[mkInlineInput({id:"inputX","class":"input-micro",maxlength:4,label:"X",value:advFtrSettings.fdx,change:curry(updateFromInput,advFtrSettings,"fdx","inputX")}),mkInlineInput({id:"inputY","class":"input-micro",maxlength:4,label:"Y",value:advFtrSettings.fdy,change:curry(updateFromInput,advFtrSettings,"fdy","inputY")}),mkInlineInput({id:"inputW","class":"input-micro",maxlength:4,label:"W",value:advFtrSettings.fdw,change:curry(updateFromInput,advFtrSettings,"fdw","inputW")}),mkInlineInput({id:"inputH","class":"input-micro",label:"H",maxlength:4,value:advFtrSettings.fdh,change:curry(updateFromInput,advFtrSettings,"fdh","inputH")})]),"")}function a(){var p=videoManager.getProperty("ROIs","videoFaceDet");logDebug("get rois is ",p);p=p.split(/:/);logDebug("get xywh is ",p);var o=getAdvFtrStreamSize();var m=parseDecimal(p[0]);var r=parseDecimal(p[1]);var n=parseDecimal(p[2]);var q=parseDecimal(p[3]);advFtrSettings.fdx=m;advFtrSettings.fdy=r;advFtrSettings.fdw=n;advFtrSettings.fdh=q;$("#inputX").val(m);$("#inputY").val(r);$("#inputW").val(n);$("#inputH").val(q);$("#faceDetModal").modal("hide").remove();videoManager.showAll();$("#roiDiv").html(g())}function k(){var m=parseDecimal($("#inputX").val());var q=parseDecimal($("#inputY").val());var n=parseDecimal($("#inputW").val());var p=parseDecimal($("#inputH").val());var o=getAdvFtrStreamSize();if(m+n<=o.Width&&q+p<=o.Height){return{valid:true,msg:""}}else{return{valid:false,msg:"Please enter valid X, Y, Width, Height"}}}function c(){var n=k();if(n.valid){videoManager.hideAll();var t=mkElem("h3",{},"Region Of Interest");var m=mkElem("div",{id:"regionConfId"},centerWrap(mkElem("div",{id:"videoAnchorFaceDet","class":"bttm"})));var s=mkElem("div",{},[mkButton("Ok","btn-primary").click(a)," ",mkButton("Cancel"," ").click(i)," ",mkButton("Clear"," ").click(function(){videoManager.setProperty("deleteROIs",-1,"videoFaceDet")})]);var q=getAdvFtrStreamSize();var p=mkModalElem("faceDetModal"," ",t,m,s,standardModalOptions,true,i);var r={width:$("#faceDetModal").width(),height:$("#faceDetModal").height()+100};d=getPluginWidthAndHeight(advFtrSettings,r,1);var o=[parseDecimal($("#inputX").val()),parseDecimal($("#inputY").val()),parseDecimal($("#inputW").val()),parseDecimal($("#inputH").val())].join(":");addVideoDiv(videoSettings,"#videoAnchorFaceDet",d.width,d.height,"videoFaceDet");videoManager.setProperty("totalROIs",1,"videoFaceDet");videoManager.setProperty("streamResolution",getStreamResolution(advFtrSettings),"videoFaceDet");videoManager.setProperty("ROIs",o,"videoFaceDet");videoManager.setProperty("uimode",PLUGIN_UI_MODE.ROI,"videoFaceDet");videoManager.play(videoSettings.getStreamUrl(0),"videoFaceDet")}else{showOverlaidMessageModal("Message",n.msg)}}function j(){d=getPluginWidthAndHeight(advFtrSettings,getMainBarHalfAvailableSpace(),1);var o=mkElemId("div","motionId",centerWrap(mkElemId("div","videoAnchorMain")));var n=mkElem("div",{id:"advFeatureRightPanel","class":"span6"},[mkPrependedInput("Camera",{id:"inputCamera",value:advFtrSettings.title,"class":"input-medium",disabled:"disabled"},"icon-camera"),mkControlGroup("Motion Detection",mkButton("Configure"," ",l),""),mkBreak(),mkBreak(),mkBreak(),mkElem("h4",{},"Face Detection Setting"),mkControlGroup("Face Detect",mkElemClass("div","form-inline",[mkInlineSelectionInput(" ","selectFaceDetecterId",advFtrSettings.faceDetects,{selectClass:"input-medium",selectedIndex:advFtrSettings.fdetect,change:curry(updateFromCombo,advFtrSettings,"fdetect","selectFaceDetecterId")}),mkButton("Configure").click(c)]),""),mkElem("div",{id:"roiDiv"}),mkInput({label:"Confidence Level",help:" %","class":"input-small",maxlength:3,id:"fdcflvl",value:advFtrSettings.fdconflevel,change:curry(updateFromInput,advFtrSettings,"fdconflevel","fdcflvl")}),mkControlGroup("Direction",mkInlineSelectionInput(" ","selectDirectionId",advFtrSettings.faceDetectDirs,{selectClass:"input-medium",selectedIndex:advFtrSettings.fddirection,change:curry(updateFromCombo,advFtrSettings,"fddirection","selectDirectionId")}),"")]);var p=mkElem("div",{id:"advFeatureLeftPanel","class":"span6"},[mkElemId("div","videoId",o),mkElemId("div","confId")]);var m=mkElemClass("div",null,[mkElem("h4",{},"Face Recognition Settings"),mkElemClass("div","row-fluid",[mkElemClass("div","span6",[mkControlGroup("Face Recognition",mkInlineSelectionInput(" ","selectFaceRecgId",advFtrSettings.faceRecogninations,{selectClass:"input-medium",selectedIndex:advFtrSettings.frecognition,change:curry(updateFromCombo,advFtrSettings,"frecognition","selectFaceRecgId")}),""),mkInput({label:"Confidence Level",help:" %","class":"input-small",maxlength:3,id:"frconfLevel",value:advFtrSettings.frconflevel,change:curry(updateFromInput,advFtrSettings,"frconflevel","frconfLevel")}),mkControlGroup("Database",mkElemClass("div","form-inline",[mkInlineRadioButtonElem("SD/ MMC","databaseOffId","databaseGroup",{checked:advFtrSettings.frdatabase===0,change:function(s){if(s){advFtrSettings.frdatabase=advFtrSettings.frdatabase===0?1:0}}}),mkInlineRadioButtonElem("NAND","databaseOnId","databaseGroup",{checked:advFtrSettings.frdatabase===1,change:function(s){if(s){advFtrSettings.frdatabase=advFtrSettings.frdatabase===0?1:0}}})]),"")]),mkElemClass("div","span6",[mkElem("h5",{},"Privacy Mask"),mkControlGroup("Privacy Mask",mkElemClass("div","form-inline",[mkInlineRadioButtonElem("Off","privacyMaskOffId","maskGroup",{checked:advFtrSettings.privacymask===0,change:function(s){if(s){advFtrSettings.privacymask=advFtrSettings.privacymask===0?1:0}}}),mkInlineRadioButtonElem("On","privacyMaskOnId","maskGroup",{checked:advFtrSettings.privacymask===1,change:function(s){if(s){advFtrSettings.privacymask=advFtrSettings.privacymask===0?1:0}}})]),""),mkControlGroup("Mask Option",mkInlineSelectionInput(" ","selectMaskOptionId",advFtrSettings.maskOptions,{selectClass:"input-medium",selectedIndex:advFtrSettings.maskoptions,change:curry(updateFromCombo,advFtrSettings,"maskoptions","selectMaskOptionId")}),"")])])]);var q=mkElemClass("div","form-horizontal row-fluid",[p,n,m]);var r=mkElemClass("div","form-actions",[mkButton("Ok","btn-primary",mkVerboseSaver(saveAdvFtrSettings,"Advanced Feature settings saved to "+advFtrSettings.title,openAdvFeatures))," ",mkButton("Cancel",null,openAdvFeatures)]);$("#mainbar").html(mkElem("div",{},[mkElem("h2",{},"Advanced Features"),mkElemId("div","modalContainer"),mkBreak(),mkUpdateModal(),q,mkSaveStatusDiv(),r]));$("#roiDiv").html(g());showPendingStatus();addVideoDiv(videoSettings,"#videoAnchorMain",d.width-30,d.height);videoManager.play(videoSettings.getStreamUrl(0));adjustSidebarHeight();$.each(["#frconfLevel","#fdcflvl","#inputX","#inputY","#inputW","#inputH"],function(s,t){validateNumericField(t)})}$.ajax({url:IPNC.serverURL+"ini.htm",success:function(m){var n=parseINI(m);videoSettings=initVideoSettings(n);origAdvFtrSettings=$.extend({},n,{faceDetects:n.fdetectname.split(/;/),faceRecogninations:n.frecognitionname.split(/;/),maskOptions:n.maskoptionsname.split(/;/),motions:n.motionname.split(/;/),faceDetectDirs:n.fddirectionname.split(/;/)});advFtrSettings=$.extend({},origAdvFtrSettings);j()}})}function closeAdvFeature(a){if(isDifferent(origAdvFtrSettings,advFtrSettings)){videoManager.hideAll();showConfirmationModal("Message","Do you want to save the changes?",curry(saveAdvFtrSettings,a),a,true)}else{a()}};